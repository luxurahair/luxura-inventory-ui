<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Luxura ‚Ä¢ Gestion d‚Äôinventaire</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg:#0a0a0a; --panel:#111; --line:#1e1e1e; --fg:#f7f7f5; --muted:#b9b9b4;
      --gold:#d4af37; --gold-2:#b8932e; --danger:#ff6b6b; --ok:#8BE28B;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--fg);font-family:Inter,system-ui,Roboto,sans-serif}
    .wrap{max-width:1100px;margin:0 auto;padding:24px}

    .topbar{display:flex;align-items:center;justify-content:space-between;margin-bottom:16px}
    .brand{display:flex;gap:12px;align-items:center}
    .logo{
      width:48px;height:48px;border-radius:10px;
      background:linear-gradient(135deg,var(--gold),var(--gold-2));
      display:flex;align-items:center;justify-content:center;
      overflow:hidden; box-shadow:0 0 0 1px #2a2a2a;
    }
    .logo img{ width:100%; height:100%; object-fit:contain; }

    .title{font-weight:800;font-size:18px}
    .muted{color:var(--muted);font-size:12px}

    .card{background:var(--panel);border:1px solid var(--line);border-radius:16px;padding:16px}
    .grid{display:grid;gap:16px;grid-template-columns:1fr 1fr}
    @media(max-width:900px){.grid{grid-template-columns:1fr}}

    label{display:block;font-size:12px;color:var(--muted);margin-bottom:6px}
    input,select{
      width:100%;padding:10px;border:1px solid var(--line);
      border-radius:12px;background:#0d0d0d;color:var(--fg);
    }
    button{
      padding:10px 14px;border:1px solid var(--gold-2);
      border-radius:12px;background:var(--gold);color:#111;
      cursor:pointer;font-weight:700;
    }
    .btn-ghost{background:transparent;color:var(--fg);border-color:var(--line)}
    .toolbar{display:flex;gap:10px;align-items:center;flex-wrap:wrap}

    table{width:100%;border-collapse:collapse;font-size:14px}
    th,td{padding:10px;border-bottom:1px solid var(--line);text-align:left}
    h3{margin:0 0 10px;font-size:16px}
    .ok{color:var(--ok)} .err{color:var(--danger)}

    /* Toast */
    .toast{
      position:fixed; left:50%; bottom:24px;
      transform:translateX(-50%) translateY(20px);
      background:#141414;border:1px solid #2a2a2a;color:var(--fg);
      padding:10px 14px;border-radius:12px;
      box-shadow:0 10px 30px rgba(0,0,0,.35);
      opacity:0; pointer-events:none; transition:.25s; z-index:9999; 
    }
    .toast.show{opacity:1; transform:translateX(-50%) translateY(0);}
    .toast.ok{border-color:#214a21;color:#d8f7d8}
    .toast.err{border-color:#5a2a2a;color:#ffd7d7}
  </style>
</head>

<body>
  <div class="wrap">
    <div class="topbar">
      <div class="brand">
        <div class="logo">
          <img id="logoImg" src="https://static.wixstatic.com/media/de6cdb_1818e78bd1294722811849c73ea77774~mv2.png">
        </div>
        <div>
          <div class="title">Luxura ‚Äî Inventaire multi-salons</div>
          <div class="muted">Interface noire & or ‚Ä¢ connect√©e √† l‚ÄôAPI Render</div>
        </div>
      </div>
      <div class="muted">v1.2</div>
    </div>

    <!-- CONFIG -->
    <div class="card" style="margin-bottom:16px;">
      <div class="grid">
        <div>
          <label>URL de l‚ÄôAPI</label>
          <input id="apiUrl" oninput="saveCfg()" />
        </div>
        <div>
          <label>Cl√© API (optionnel)</label>
          <input id="apiKey" placeholder="(laisser vide)" oninput="saveCfg()" />
        </div>
      </div>

      <div class="toolbar" style="margin-top:10px;">
        <button onclick="testApi()">Tester la connexion</button>
        <button class="btn-ghost" onclick="refreshAll()">Rafra√Æchir donn√©es</button>
        <span id="testStatus" class="muted"></span>
      </div>
    </div>

    <!-- SALONS + PRODUITS -->
    <div class="grid">
      <div class="card">
        <h3>Salons</h3>
        <form class="toolbar" onsubmit="createSalon(event)">
          <input id="salonName" placeholder="Nom du salon">
          <input id="salonAddr" placeholder="Adresse">
          <button>Ajouter</button>
        </form>
        <div id="salonsList" class="muted">Aucun salon‚Ä¶</div>
      </div>

      <div class="card">
        <h3>Produits</h3>
        <form class="toolbar" onsubmit="createProduct(event)">
          <input id="prodSku" placeholder="SKU">
          <input id="prodName" placeholder="Nom du produit">
          <input id="prodLen" placeholder="Longueur (ex. 18)">
          <input id="prodColor" placeholder="Couleur">
          <input id="prodPrice" placeholder="Prix">
          <button>Ajouter</button>
        </form>
        <div id="productsList" class="muted">Aucun produit‚Ä¶</div>
      </div>
    </div>

    <!-- INVENTAIRE -->
    <div class="card" style="margin-top:16px;">
      <h3>Inventaire</h3>
      <div class="toolbar">
        <select id="filterSalon" onchange="loadInventory()"></select>
        <select id="filterProduct" onchange="loadInventory()"></select>
      </div>
      <div id="inventoryTable" class="muted">Aucune donn√©e‚Ä¶</div>

      <div id="actionLog" class="muted" style="margin-top:10px; max-height:160px; overflow:auto; border:1px solid var(--line); border-radius:12px; padding:10px; background:#0d0d0d">
        <div class="muted">Logs: pr√™t.</div>
      </div>
    </div>

    <!-- MOUVEMENTS -->
    <div class="card" style="margin-top:16px;">
      <h3>Mouvement</h3>

      <div class="toolbar" style="margin-bottom:8px;">
        <button class="btn-ghost" onclick="quickType('IN')">‚ûï IN</button>
        <button class="btn-ghost" onclick="quickType('OUT')">‚ûñ OUT</button>
        <button class="btn-ghost" onclick="quickType('SALE')">üí∏ SALE</button>
        <button class="btn-ghost" onclick="quickType('ADJUST')">‚öôÔ∏è ADJUST</button>
        <span class="muted">Choisis un type puis entre la quantit√©</span>
      </div>

      <div class="grid">
        <div><label>Type</label><select id="movType">
          <option>IN</option><option>OUT</option>
          <option>SALE</option><option>ADJUST</option>
        </select></div>
        <div><label>Salon</label><select id="movSalon"></select></div>
        <div><label>Produit</label><select id="movProduct"></select></div>
        <div><label>Quantit√©</label><input id="movQty" placeholder="ex. 5"></div>
        <div style="grid-column:1/-1;"><label>Note</label><input id="movNote"></div>
      </div>

      <div class="toolbar" style="margin-top:10px;">
        <button onclick="submitMovement()">Enregistrer</button>
        <span id="movStatus" class="muted"></span>
      </div>
    </div>
  </div>

  <div id="toast" class="toast"></div>

<script>
/* =========================
   CONFIG + URL CLEANER
========================= */
function cfg() {
  let api = document.getElementById("apiUrl").value.trim();

  // Valeur par d√©faut
  if (!api) api = "https://luxura-inventory-api.onrender.com";

  // Nettoyage : garder juste le domaine
  try {
    const u = new URL(api);
    api = u.origin;
  } catch (e) {}

  document.getElementById("apiUrl").value = api;
  localStorage.setItem("apiUrl", api);

  const apiKey = document.getElementById("apiKey").value.trim();
  localStorage.setItem("apiKey", apiKey);

  return { apiUrl: api, apiKey };
}

function saveCfg() { cfg(); }

function headers() {
  const h = { "Content-Type": "application/json" };
  const k = localStorage.getItem("apiKey");
  if (k) h["x-api-key"] = k;
  return h;
}

function setStatus(id,msg,ok=true){
  const el=document.getElementById(id);
  el.textContent=msg;
  el.className=(ok?"ok":"err")+" muted";
}

function toast(msg, ok=true){
  const el=document.getElementById("toast");
  el.textContent=msg;
  el.className="toast "+(ok?"ok":"err");
  void el.offsetWidth;
  el.classList.add("show");
  setTimeout(()=>el.classList.remove("show"),2000);
}

function logLine(msg){
  const el=document.getElementById('actionLog');
  if(!el) return;
  const t=new Date();
  const stamp=t.toLocaleString('fr-CA');
  const line=document.createElement('div');
  line.textContent=`[${stamp}] ${msg}`;
  el.prepend(line);
}

/* =========================
        WIX BRIDGE (postMessage RPC)
========================= */
const WixBridge = (() => {
  const pending = new Map();

  window.addEventListener("message", (ev) => {
    const msg = ev.data || {};
    if (!msg.id || !pending.has(msg.id)) return;

    const { resolve, reject } = pending.get(msg.id);
    pending.delete(msg.id);

    if (msg.ok) resolve(msg.data);
    else reject(new Error(msg.error || "Unknown error"));
  });

  function call(action, payload) {
    const id = `${Date.now()}_${Math.random().toString(16).slice(2)}`;
    return new Promise((resolve, reject) => {
      pending.set(id, { resolve, reject });

      // on envoie au parent Wix
      window.parent.postMessage({ id, action, payload }, "*");

      setTimeout(() => {
        if (!pending.has(id)) return;
        pending.delete(id);
        reject(new Error("Timeout WixBridge"));
      }, 15000);
    });
  }

  return { call };
})();

/* =========================
         API TEST
========================= */
async function testApi(){
  try {
    const res = await WixBridge.call("ping");
    setStatus("testStatus", "Connexion OK");
    toast("Connexion OK", true);
    logLine("Bridge OK: " + JSON.stringify(res));
  } catch (e) {
    console.log("BRIDGE ERROR:", e);
    setStatus("testStatus","Impossible de joindre l‚ÄôAPI",false);
    toast("Impossible de joindre l‚ÄôAPI",false);
    logLine("Bridge FAIL: " + (e?.message || e));
  }
  refreshAll();
}

/* =========================
         CRUD SALONS
========================= */
async function createSalon(e){
  e.preventDefault();
  const n = document.getElementById("salonName").value.trim();
  const a = document.getElementById("salonAddr").value.trim();
  if (!n) return;

  try {
    await WixBridge.call("createSalon", { name: n, address: a });
    toast("Salon ajout√©", true);
    logLine("Salon ajout√©: " + n);
    document.getElementById("salonName").value = "";
    document.getElementById("salonAddr").value = "";
    await loadSalons();
  } catch (e) {
    toast("Erreur ajout salon", false);
    logLine("Erreur ajout salon: " + (e?.message || e));
  }
}

/* =========================
        CRUD PRODUITS
========================= */
async function createProduct(e){
  e.preventDefault();

  const sku = document.getElementById("prodSku").value.trim();
  const name = document.getElementById("prodName").value.trim();
  if (!sku || !name) return;

  const payload = {
    sku,
    name,
    length_inch: parseInt(document.getElementById("prodLen").value) || null,
    color: document.getElementById("prodColor").value.trim() || null,
    price: parseFloat(document.getElementById("prodPrice").value) || null
  };

  try {
    await WixBridge.call("createProduct", payload);
    toast("Produit ajout√©", true);
    logLine("Produit ajout√©: " + sku + " ‚Äî " + name);

    document.getElementById("prodSku").value = "";
    document.getElementById("prodName").value = "";
    document.getElementById("prodLen").value = "";
    document.getElementById("prodColor").value = "";
    document.getElementById("prodPrice").value = "";

    await loadProducts();
  } catch (e) {
    toast("Erreur ajout produit", false);
    logLine("Erreur ajout produit: " + (e?.message || e));
  }
}

/* =========================
         INVENTAIRE (MULTI-SALON CLEAN)
========================= */
async function loadInventory(){
  const s = document.getElementById('filterSalon').value;
  const p = document.getElementById('filterProduct').value;

  const rows = await WixBridge.call("getInventoryView", {
    salon_id: s || "",
    product_id: p || ""
  });

  document.getElementById('inventoryTable').innerHTML = rows.length
    ? `<table>
        <tr>
          <th>Salon</th><th>SKU</th><th>Produit</th><th>Qt√©</th><th>Actif</th><th>Wix</th>
        </tr>
        ${rows.map(i=>`<tr>
          <td>${i.salon_id}</td>
          <td>${i.sku||''}</td>
          <td>${i.name||''}</td>
          <td>${(i.quantity ?? 0)}</td>
          <td>${i.is_active===null?'':(i.is_active?'‚úÖ':'‚ùå')}</td>
          <td>${i.wix_id||''}</td>
        </tr>`).join('')}
      </table>`
    : "<div class='muted'>Aucune donn√©e‚Ä¶</div>";

  logLine(`Inventaire charg√© (${rows.length} lignes)${s?` ‚Ä¢ salon ${s}`:''}${p?` ‚Ä¢ produit ${p}`:''}`);
}

/* =========================
        MOUVEMENTS
========================= */
function quickType(t){
  document.getElementById("movType").value=t;
  document.getElementById("movQty").focus();
  toast("Type "+t,true);
  logLine("Type mouvement: "+t);
}

async function submitMovement(){
  const type = document.getElementById("movType").value.trim();
  const salon_id = parseInt(document.getElementById("movSalon").value);
  const product_id = parseInt(document.getElementById("movProduct").value);
  const qty = parseInt(document.getElementById("movQty").value);
  const note = document.getElementById("movNote").value.trim();

  if(!type || !salon_id || !product_id || !qty){
    toast("Champs invalides", false);
    logLine("Mouvement refus√©: champs invalides");
    return;
  }

  try {
    await WixBridge.call("submitMovement", { type, salon_id, product_id, qty, note });
    toast("Mouvement enregistr√©", true);
    logLine(`Mouvement OK: ${type} ‚Ä¢ salon ${salon_id} ‚Ä¢ prod ${product_id} ‚Ä¢ qty ${qty}${note?` ‚Ä¢ note: ${note}`:''}`);
    document.getElementById("movQty").value = "";
    await loadInventory();
  } catch (e) {
    toast("Erreur mouvement", false);
    logLine("Mouvement FAIL: " + (e?.message || e));
  }
}

async function loadSalons(){
  try {
    const rows = await WixBridge.call("getSalons");

    const opts = rows.map(s => `<option value="${s.id}">${s.name}</option>`).join("");
    document.getElementById("filterSalon").innerHTML = `<option value="">‚Äî Tous les salons ‚Äî</option>` + opts;
    document.getElementById("movSalon").innerHTML   = `<option value="">‚Äî Tous les salons ‚Äî</option>` + opts;

    document.getElementById("salonsList").innerHTML = rows.length
      ? `<table><tr><th>ID</th><th>Nom</th><th>Adresse</th></tr>${
          rows.map(s=>`<tr><td>${s.id}</td><td>${s.name}</td><td>${s.address||""}</td></tr>`).join("")
        }</table>`
      : "<div class='muted'>Aucun salon‚Ä¶</div>";

    logLine(`Salons charg√©s: ${rows.length}`);
  } catch (e) {
    toast("Erreur salons", false);
    logLine("‚ùå getSalons FAIL: " + (e?.message || e));
    document.getElementById("salonsList").innerHTML = "<div class='muted'>‚ùå Erreur salons</div>";
  }
}

 async function loadProducts(){
  try {
    const rows = await WixBridge.call("getProducts");

    const opts = rows.map(p => `<option value="${p.id}">${p.sku} ‚Äî ${p.name}</option>`).join("");
    document.getElementById("filterProduct").innerHTML = `<option value="">‚Äî Tous les produits ‚Äî</option>` + opts;
    document.getElementById("movProduct").innerHTML    = `<option value="">‚Äî Tous les produits ‚Äî</option>` + opts;

    document.getElementById("productsList").innerHTML = rows.length
      ? `<table><tr><th>ID</th><th>SKU</th><th>Nom</th><th>Long.</th><th>Couleur</th><th>Prix</th></tr>${
          rows.map(p=>`<tr><td>${p.id}</td><td>${p.sku}</td><td>${p.name}</td><td>${p.length_inch||""}</td><td>${p.color||""}</td><td>${p.price||""}</td></tr>`).join("")
        }</table>`
      : "<div class='muted'>Aucun produit‚Ä¶</div>";

    logLine(`Produits charg√©s: ${rows.length}`);
  } catch (e) {
    toast("Erreur produits", false);
    logLine("‚ùå getProducts FAIL: " + (e?.message || e));
    document.getElementById("productsList").innerHTML = "<div class='muted'>‚ùå Erreur produits</div>";
  }
}
 
/* =========================
           INIT
========================= */
async function refreshAll(){await loadSalons();await loadProducts();await loadInventory();}

(function init(){
  if(!localStorage.getItem("apiUrl")){
    localStorage.setItem("apiUrl","https://luxura-inventory-api.onrender.com");
  }

  document.getElementById("apiUrl").value = localStorage.getItem("apiUrl");
  document.getElementById("apiKey").value = localStorage.getItem("apiKey") || "";

  // ‚úÖ D√©sactive parce qu'on passe par Wix Proxy (postMessage)
  document.getElementById("apiUrl").disabled = true;
  document.getElementById("apiKey").disabled = true;
  document.getElementById("apiUrl").value = "Wix Proxy (postMessage)";

  refreshAll();
})();
</script>

</body>
</html>
